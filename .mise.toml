# Mise configuration for dotfiles repository
# Task runner for linting and testing

[tools]
shellcheck = "latest"
bats = "latest"
# Note: nushell is provided by system installation

[tasks.lint]
description = "Run shellcheck on all bash scripts"
run = """
echo "Running shellcheck..."
shellcheck \
  private_dot_local/lib/wkflw-ntfy/core/executable_* \
  private_dot_local/lib/wkflw-ntfy/marker/executable_* \
  private_dot_local/lib/wkflw-ntfy/macos/executable_wkflw-ntfy-macos-* \
  private_dot_local/lib/wkflw-ntfy/linux/executable_* \
  private_dot_local/lib/wkflw-ntfy/push/executable_* \
  private_dot_local/lib/wkflw-ntfy/escalation/executable_* \
  private_dot_local/lib/wkflw-ntfy/hooks/executable_* \
  run_once_after_wkflw-ntfy-generate-topic.sh.tmpl \
  test/wkflw-ntfy/helpers/*.bash \
  test/wkflw-ntfy/mocks/executable_*

echo "✓ Shellcheck passed!"
"""

[tasks.test]
description = "Run wkflw-ntfy unit tests"
run = """
echo "Running wkflw-ntfy unit tests..."
# Note: Add --jobs 4 for parallel execution (requires GNU parallel: brew install parallel)
bats test/wkflw-ntfy/unit/
"""

[tasks.ci]
description = "Run complete CI suite (lint + test in parallel)"
run = """
mise run lint &
LINT_PID=$!
mise run test &
TEST_PID=$!

wait $LINT_PID
LINT_EXIT=$?

wait $TEST_PID
TEST_EXIT=$?

if [ $LINT_EXIT -ne 0 ] || [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "❌ CI failed!"
  exit 1
fi

echo ""
echo "✓ All CI checks passed!"
"""

[tasks.install-hooks]
description = "Install git pre-commit hooks"
run = """
git config core.hooksPath .githooks
chmod +x .githooks/pre-commit
echo "✓ Git hooks installed. Pre-commit will run lint + test."
"""
