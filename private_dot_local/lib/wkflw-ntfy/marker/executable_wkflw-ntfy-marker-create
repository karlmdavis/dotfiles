#!/usr/bin/env bash
# wkflw-ntfy-marker-create: Create marker file for progressive escalation
#
# Usage: wkflw-ntfy-marker-create <session-id> <event-type> <cwd>
#   session-id: Unique session identifier
#   event-type: claude-stop, claude-notification, nushell
#   cwd: Current working directory
#
# Outputs: Full path to created marker file

set -euo pipefail

# Load config and logging
# Resolve symlinks to find actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# shellcheck disable=SC1091  # Config path is dynamic (resolved from symlink)
source "$SCRIPT_DIR/../core/wkflw-ntfy-config"

session_id="${1:-}"
event_type="${2:-}"
cwd="${3:-}"

if [[ -z "$session_id" || -z "$event_type" || -z "$cwd" ]]; then
    echo "Usage: wkflw-ntfy-marker-create <session-id> <event-type> <cwd>" >&2
    exit 1
fi

# Create markers directory
markers_dir="$WKFLW_NTFY_STATE_DIR/markers"
mkdir -p "$markers_dir"

# Marker filename based on session ID
marker_file="$markers_dir/${session_id}"

# Write JSON payload using jq for safe escaping (prevents injection)
jq -n \
  --arg session "$session_id" \
  --arg event "$event_type" \
  --arg cwd "$cwd" \
  --argjson pid $$ \
  '{
    session_id: $session,
    event_type: $event,
    timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
    pid: $pid,
    cwd: $cwd
  }' > "$marker_file"

"$SCRIPT_DIR/../core/wkflw-ntfy-log" "$session_id" debug "marker-create" "Created marker: $marker_file"
echo "$marker_file"
