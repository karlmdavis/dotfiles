#!/usr/bin/env bash
# wkflw-ntfy-config: Load configuration from environment variables
#
# Usage: source wkflw-ntfy-config
#
# Sets environment variables with defaults:
# - WKFLW_NTFY_SERVER (default: https://ntfy.sh)
# - WKFLW_NTFY_NUSHELL_THRESHOLD (default: 90)
# - WKFLW_NTFY_ESCALATION_DELAY (default: 120)
# - WKFLW_NTFY_DEBUG (default: 0)
# - WKFLW_NTFY_TOPIC (from state file or env)
# - WKFLW_NTFY_STATE_DIR (default: ~/.local/state/wkflw-ntfy)

set -euo pipefail

# State directory for config and marker files
: "${WKFLW_NTFY_STATE_DIR:=$HOME/.local/state/wkflw-ntfy}"

# Configuration with defaults
: "${WKFLW_NTFY_SERVER:=https://ntfy.sh}"
: "${WKFLW_NTFY_NUSHELL_THRESHOLD:=90}"
: "${WKFLW_NTFY_ESCALATION_DELAY:=120}"
: "${WKFLW_NTFY_DEBUG:=0}"

# Read ntfy topic from state file if not already set
if [[ -z "${WKFLW_NTFY_TOPIC:-}" ]]; then
    config_file="$WKFLW_NTFY_STATE_DIR/config"
    if [[ -f "$config_file" ]]; then
        # Source config file to load WKFLW_NTFY_TOPIC
        # shellcheck disable=SC1090
        source "$config_file"
    else
        echo "WARNING: WKFLW_NTFY_TOPIC not set and config file not found at $config_file" >&2
        echo "Mobile push notifications will not work until topic is configured." >&2
    fi
fi

# Export all config for use by child processes
export WKFLW_NTFY_STATE_DIR
export WKFLW_NTFY_SERVER
export WKFLW_NTFY_NUSHELL_THRESHOLD
export WKFLW_NTFY_ESCALATION_DELAY
export WKFLW_NTFY_DEBUG
export WKFLW_NTFY_TOPIC
