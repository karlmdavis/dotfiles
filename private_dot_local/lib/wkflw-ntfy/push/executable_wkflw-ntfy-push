#!/usr/bin/env bash
# wkflw-ntfy-push: Send mobile push notification via ntfy
#
# Usage: wkflw-ntfy-push <session-id> <title> <body>

set -euo pipefail

# Load config and logging
# Resolve symlinks to find actual script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# shellcheck disable=SC1091
source "$SCRIPT_DIR/../core/wkflw-ntfy-config"

session_id="${1:-}"
title="${2:-}"
body="${3:-}"

if [[ -z "$session_id" || -z "$title" || -z "$body" ]]; then
    echo "Usage: wkflw-ntfy-push <session-id> <title> <body>" >&2
    exit 1
fi

if [[ -z "${WKFLW_NTFY_TOPIC:-}" ]]; then
    "$SCRIPT_DIR/../core/wkflw-ntfy-log" "$session_id" error "push" "WKFLW_NTFY_TOPIC not set"
    exit 1
fi

if ! command -v curl &>/dev/null; then
    "$SCRIPT_DIR/../core/wkflw-ntfy-log" "$session_id" warning "push" "curl not found, cannot send push notification"
    exit 1
fi

# Send notification via ntfy
url="$WKFLW_NTFY_SERVER/$WKFLW_NTFY_TOPIC"

if curl -X POST "$url" \
    -H "Title: $title" \
    -d "$body" \
    --silent --show-error --fail \
    >/dev/null 2>&1; then
    "$SCRIPT_DIR/../core/wkflw-ntfy-log" "$session_id" debug "push" "Sent push notification: $title"
else
    "$SCRIPT_DIR/../core/wkflw-ntfy-log" "$session_id" warning "push" "Failed to send push notification (server unreachable?)"
    exit 1
fi
